<!DOCTYPE html>
<html>
<head>
    <title>Book Catalogue</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
          font-family: Arial, sans-serif;
          background-color: #f5f9ff;
          margin: 0;
          padding: 0;
        }

        header {
          background-color: #003366;
          color: white;
          text-align: center;
          padding: 15px;
          position: relative;
        }

        .logout {
          position: absolute;
          right: 20px;
          top: 15px;
          background-color: #e60000;
          color: white;
          padding: 8px 16px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        }

        .logout:hover {
          background-color: #cc0000;
        }

        .container {
          width: 95%;
          margin: 20px auto;
          background: white;
          border-radius: 8px;
          padding: 20px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        h2 {
          text-align: center;
          color: #003366;
        }

        .book-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
          gap: 20px;
          margin-top: 25px;
        }

        .book-card {
          background: #fafafa;
          border-radius: 10px;
          padding: 15px;
          text-align: center;
          transition: 0.3s;
          border: 1px solid #ddd;
        }

        .book-card:hover {
          background: #eaf3ff;
          transform: translateY(-3px);
        }

        .book-card img {
          width: 200px;
          height: 200px;
          border-radius: 5px;
        }

        .book-card i {
          color: red;
        }

        .book-card i:hover {
          color: green;
        }

        .btn {
          background-color: #003366;
          color: white;
          padding: 8px 16px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin: 5px;
        }

        .btn:hover {
          background-color: #0055aa;
        }
    </style>
</head>

<body>
<header>
    <h1>Online Book Catalogue</h1>
    <button class="logout" onclick="logout()">Logout</button>
    <button class="btn" onclick="goToCart()">üõí Cart</button>
</header>

<div class="container">
    <h2>Available Books</h2>
    <div id="bookGrid" class="book-grid"></div>
</div>

<script>
    /* -------- Modal Controls -------- */
    function openModal(id) {
      document.getElementById(id).style.display = 'flex';
    }
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    /* -------- Book Loading (only if logged in) -------- */
    async function showBooks() {
      const userEmail = localStorage.getItem("userEmail");
      if (!userEmail) {
        // üîí Not logged in ‚Üí open login popup
        openModal("loginModal");
        alert("Please login to view books!");
        return;
      }

      const container = document.getElementById('content');
      container.innerHTML = "<p>Loading books...</p>";

      try {
        const res = await fetch("http://localhost:8080/api/books/all");
        if (!res.ok) throw new Error("Failed to load books");
        const books = await res.json();

        if (books.length === 0) {
          container.innerHTML = "<p>No books available right now.</p>";
          return;
        }

        container.innerHTML = `
          <h2>Available Books</h2>
          <div class="book-grid">
            ${books.map(b => `
              <div class="book-card">
                <h3>${b.title}</h3>
                <p><b>Author:</b> ${b.author}</p>
                <p><b>Category:</b> ${b.category}</p>
                <p><b>Price:</b> ‚Çπ${b.price}</p>
                <button class="btn" onclick="addToCart(${b.id}, '${b.title}', '${b.author}', ${b.price})">Add to Cart</button>
              </div>
            `).join('')}
          </div>`;
      } catch (err) {
        container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Could not load books. Server error.</p>";
        console.error(err);
      }
    }

    /* -------- Register -------- */
    async function registerUser() {
      const role = document.getElementById("role").value;
      const user = {
        firstname: document.getElementById("firstname").value,
        lastname: document.getElementById("lastname").value,
        email: document.getElementById("email").value,
        password: document.getElementById("password").value,
        dept: document.getElementById("dept").value,
        year: "1st"
      };

      const res = await fetch(`http://localhost:8080/api/users/register?type=${role}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(user)
      });

      if (res.ok) {
        alert(`${role} registration successful!`);
        closeModal('registerModal');
      } else {
        alert("Registration failed!");
      }
    }

    /* -------- Login -------- */
    async function loginUser() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      try {
        const res = await fetch("http://localhost:8080/api/users/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        if (res.ok) {
          const loggedUser = await res.json();
          alert(`Welcome, ${loggedUser.firstname}!`);

          localStorage.setItem("userEmail", loggedUser.email);
          localStorage.setItem("userRole", loggedUser.role);

          closeModal("loginModal");
          updateHeaderButtons();
          showBooks(); // ‚úÖ Auto-show books after login
        } else {
          alert("‚ùå Invalid credentials!");
        }
      } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Server not reachable");
      }
    }

    /* -------- Header Button Control -------- */
    function updateHeaderButtons() {
      const userEmail = localStorage.getItem("userEmail");
      const userRole = localStorage.getItem("userRole");

      const loginBtn = document.getElementById("loginBtn");
      const registerBtn = document.getElementById("registerBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const adminBtn = document.getElementById("adminBtn");
      const cartBtn = document.getElementById("cartBtn");

      if (!loginBtn || !registerBtn || !logoutBtn || !adminBtn || !cartBtn) return;

      if (userEmail) {
        loginBtn.style.display = "none";
        registerBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        cartBtn.style.display = "inline-block";
        if (userRole === "ADMIN") adminBtn.style.display = "inline-block";
      } else {
        loginBtn.style.display = "inline-block";
        registerBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        adminBtn.style.display = "none";
        cartBtn.style.display = "none";
      }
    }

    /* -------- Logout -------- */
    function logout() {
      localStorage.clear();
      alert("You have been logged out.");
      updateHeaderButtons();
      document.getElementById('content').innerHTML = `
        <h2>Welcome to the Online Bookstore</h2>
        <p style="font-size:16px; margin-top:10px;">
          Explore and purchase your favorite books with ease.
          Login or Register to get started.
        </p>`;
    }

    /* -------- Add to Cart -------- */
    async function addToCart(id, title, author, price) {
      const email = localStorage.getItem("userEmail");
      if (!email) {
        openModal("loginModal");
        alert("Please login first!");
        return;
      }

      const res = await fetch("http://localhost:8080/api/cart/add", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ userEmail: email, bookId: id, title, author, price })
      });

      alert(res.ok ? "‚úÖ Added to cart!" : "‚ùå Failed to add to cart.");
    }
    /* -------- Open Cart Modal -------- */
async function openCart() {
  const email = localStorage.getItem("userEmail");
  if (!email) {
    openModal("loginModal");
    alert("Please login first!");
    return;
  }

  document.getElementById("cartModal").style.display = "flex";
  const res = await fetch(`http://localhost:8080/api/cart/${email}`);

  if (!res.ok) {
    document.getElementById("cartItems").innerHTML = "<p>‚ö†Ô∏è Could not load cart items.</p>";
    return;
  }

  const items = await res.json();
  const container = document.getElementById("cartItems");

  if (items.length === 0) {
    container.innerHTML = "<p>Your cart is empty.</p>";
    document.getElementById("totalPrice").textContent = "Total: ‚Çπ0";
    return;
  }

  let total = 0;
  container.innerHTML = items.map(i => {
    total += i.price;
    return `
      <div class="cart-item">
        <p><b>${i.title}</b> by ${i.author}</p>
        <p>‚Çπ${i.price}</p>
        <button class="btn" onclick="removeFromCart(${i.id})">Remove</button>
      </div>`;
  }).join("");

  document.getElementById("totalPrice").textContent = `Total: ‚Çπ${total}`;
}

/* -------- Remove Item from Cart -------- */
async function removeFromCart(id) {
  const res = await fetch(`http://localhost:8080/api/cart/remove/${id}`, { method: "DELETE" });
  if (res.ok) {
    alert("üóëÔ∏è Removed from cart!");
    openCart(); // reload cart
  } else {
    alert("‚ùå Failed to remove item!");
  }
}

/* -------- Checkout -------- */
async function checkout() {
  const email = localStorage.getItem("userEmail");
  const res = await fetch(`http://localhost:8080/api/orders/place/${email}`, { method: "POST" });
  if (res.ok) {
    alert("‚úÖ Order placed successfully!");
    closeModal("cartModal");
  } else {
    alert("‚ùå Checkout failed!");
  }
}

    document.addEventListener("DOMContentLoaded", updateHeaderButtons);
</script>

</body>
</html>
